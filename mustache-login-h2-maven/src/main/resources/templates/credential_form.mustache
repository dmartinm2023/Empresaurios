<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guardar contraseña</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/pw-analyzer.css">
</head>

  <style>
    .pw-wrap{margin-top:8px}
    .pw-meter{margin-top:6px;border-radius:10px;overflow:hidden;height:12px;background:#eceff1;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
    .pw-meter > div{height:100%;width:0;transition:width .25s ease, background .25s ease}
    .pw-status{display:flex;align-items:center;gap:8px;margin-top:8px}
    .pw-status .badge{border-radius:999px;padding:4px 10px;font-weight:600}
    .pw-status .badge.weak{background:#ffebee;color:#b71c1c}
    .pw-status .badge.fair{background:#fff8e1;color:#e65100}
    .pw-status .badge.good{background:#e3f2fd;color:#0d47a1}
    .pw-status .badge.strong{background:#e8f5e9;color:#1b5e20}
    .pw-entropy{font-size:.85rem;opacity:.8}
    .pw-checks{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px}
    .pw-check{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:#fafafa;border:1px solid #eee}
    .pw-check.ok{background:#f1f8e9;border-color:#c5e1a5}
    .pw-check .dot{width:10px;height:10px;border-radius:999px;background:#cfd8dc}
    .pw-check.ok .dot{background:#43a047}
    .pw-tip{margin-top:10px;font-size:.9rem}
    .pw-chips{margin-top:8px}
    .pw-chip{display:inline-block;margin:2px 4px;padding:4px 8px;border-radius:999px;background:#f5f5f5;font-size:.8rem;border:1px solid #eee;cursor:default}
    .pw-actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .pw-btn{padding:6px 10px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .pw-mini{font-size:.8rem}
  </style>


  <style>
    .pw-meter{margin-top:6px;border-radius:6px;overflow:hidden;height:10px;background:#eee}
    .pw-meter > div{height:100%;width:0;transition:width .25s ease}
    .pw-hint{font-size:.9rem;margin-top:8px;line-height:1.3}
    .pw-chip{display:inline-block;margin:2px 4px;padding:4px 8px;border-radius:999px;background:#f5f5f5;font-size:.8rem}
    .pw-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;margin-top:6px;font-size:.85rem}
    .pw-badge.weak{background:#ffebee}
    .pw-badge.fair{background:#fff8e1}
    .pw-badge.good{background:#e3f2fd}
    .pw-badge.strong{background:#e8f5e9}
    .pw-mini{font-size:.8rem;opacity:.8}
    .pw-tips{margin-top:6px}
  </style>
    
<body>
  <div class="container">
    <div class="card">
      <h1>Añadir contraseña</h1>
      <form method="post" action="/credentials/save">
        <label>Título</label>
        <input type="text" name="title" required maxlength="50">
        <label>Usuario/Email</label>
        <input type="text" name="login" required maxlength="50">
        <label>Contraseña</label>
        <input type="password" name="passwordEncrypted" required maxlength="50">
        <button class="primary" type="submit">Guardar</button>
      </form>
      <p><a href="/">Volver</a></p>
    </div>
  </div>

  <script>
  (function(){
    function scorePassword(pw, ctx){
      let score = 0;
      const tests = {
        length: pw.length >= 12,
        upper: /[A-Z]/.test(pw),
        lower: /[a-z]/.test(pw),
        digit: /\d/.test(pw),
        symbol: /[^A-Za-z0-9]/.test(pw),
        noSeq: !/(.)\1{2,}/.test(pw) && !/(0123|1234|2345|3456|4567|5678|6789|abcd|qwer|asdf|zxcv)/i.test(pw),
        notUser: ctx && ctx.user ? !pw.toLowerCase().includes(ctx.user.toLowerCase()) : true
      };
      // Base score
      score += tests.length ? 1 : 0;
      score += tests.upper ? 1 : 0;
      score += tests.lower ? 1 : 0;
      score += tests.digit ? 1 : 0;
      score += tests.symbol ? 1 : 0;
      score += tests.noSeq ? 1 : 0;
      score += tests.notUser ? 1 : 0;
      if(pw.length >= 16) score += 1;
      if(/[A-Z]/.test(pw) && /[a-z]/.test(pw) && /\d/.test(pw) && /[^A-Za-z0-9]/.test(pw)) score += 1;
      const max = 10;
      const pct = Math.min(100, Math.round(score/max*100));
      let label='Débil', cls='weak', color='#d32f2f';
      if(pct>=25){label='Aceptable';cls='fair';color='#f57c00';}
      if(pct>=50){label='Buena';cls='good';color='#1976d2';}
      if(pct>=75){label='Fuerte';cls='strong';color='#2e7d32';}
      return {pct, label, cls, color, tests};
    }
    function makeUI(input, userField){
      const wrap = document.createElement('div');
      const meter = document.createElement('div');
      meter.className='pw-meter';
      const bar = document.createElement('div');
      meter.appendChild(bar);
      const badge = document.createElement('div');
      const tips = document.createElement('div');
      tips.className='pw-tips';
      badge.className='pw-badge weak';
      wrap.appendChild(meter);
      wrap.appendChild(badge);
      wrap.appendChild(tips);
      input.insertAdjacentElement('afterend', wrap);
      function update(){
        const ctx = {user: userField ? userField.value.trim() : ''};
        const res = scorePassword(input.value, ctx);
        bar.style.width = res.pct + '%';
        bar.style.background = res.color;
        badge.className = 'pw-badge ' + res.cls;
        badge.innerHTML = '<strong>'+res.label+'</strong> <span class="pw-mini">(' + res.pct + '%)</span>';
        const missing = [];
        const t = res.tests;
        if(!t.length) missing.push('Usa ≥ 12 caracteres');
        if(!t.upper) missing.push('Añade MAYÚSCULAS');
        if(!t.lower) missing.push('Incluye minúsculas');
        if(!t.digit) missing.push('Agrega números');
        if(!t.symbol) missing.push('Incluye un símbolo como ! % _ #');
        if(!t.noSeq) missing.push('Evita secuencias o repeticiones');
        if(!t.notUser) missing.push('No uses tu usuario');
        const boosters = [
          'Tip: usa 2 palabras sin relación y 1 símbolo, ej. "Perro_Cobalto7"',
          'Idea: añade un prefijo que solo tú entiendas, p. ej. "~Tesis2025"',
          'Truco: frase corta con espacios o guiones bajos'
        ];
        tips.innerHTML = '';
        if(missing.length){
          const list = document.createElement('div');
          missing.slice(0,3).forEach(m=>{
            const chip = document.createElement('span');
            chip.className='pw-chip';
            chip.textContent = m;
            list.appendChild(chip);
          });
          tips.appendChild(list);
        }else{
          const ok = document.createElement('span');
          ok.className='ok';
          ok.textContent='¡Listo! Contraseña sólida.';
          tips.appendChild(ok);
        }
        if(res.pct < 75){
          const booster = document.createElement('div');
          booster.className='pw-hint';
          booster.textContent = boosters[Math.floor(Math.random()*boosters.length)];
          tips.appendChild(booster);
        }
      }
      input.addEventListener('input', update);
      if(userField){ userField.addEventListener('input', update); }
      update();
      return {update};
    }
    const userInput = document.querySelector('input[name="login"]');
    const passInput = document.querySelector('input[name="passwordEncrypted"]');
    if(passInput){
      makeUI(passInput, userInput);
    }
  })();
  </script>
    
  <script src="/js/pw-analyzer.js" defer></script>
</body>
</html>